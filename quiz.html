<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Take Quiz - CSM 183</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="header">
  <div class="brand">CSM 183 Quiz Portal</div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="topics.html">Topics</a>
    <a href="quiz.html">Take Quiz</a>
  </nav>
</header>

<main class="container">
  <section class="card" id="quiz-card">
    <h2 id="quiz-title">Quiz</h2>
    <div id="meta" class="small"></div>
    <div id="question-area"></div>
    <div style="margin-top:12px">
      <button id="prevBtn" class="btn" style="background:#6b7280">Previous</button>
      <button id="nextBtn" class="btn">Next</button>
      <button id="finishBtn" class="btn" style="background:#0b9bff">Finish</button>
    </div>
  </section>
  <section class="card" id="results-card" style="display:none">
    <h2>Results</h2>
    <div id="results"></div>
    <p><a id="retry" class="btn">Retry</a> <a id="home" class="btn" href="index.html" style="background:#0747a6">Home</a></p>
  </section>
</main>

<script>
var allQuestions = [];
var quizQuestions = [];
var current = 0;
var answers = {};
var params = new URLSearchParams(location.search);
var topic = params.get('topic');

fetch('questions.json').then(function(r){return r.json()}).then(function(data){
  allQuestions = data.questions;
  if(topic){
    quizQuestions = allQuestions.filter(function(q){return q.topic===topic});
    document.getElementById('quiz-title').innerText = 'Topic Quiz: ' + topic;
    document.getElementById('meta').innerText = quizQuestions.length + ' questions available in this topic.';
  } else {
    quizQuestions = shuffle(allQuestions).slice(0,20);
    document.getElementById('quiz-title').innerText = 'Random 20-question Quiz';
    document.getElementById('meta').innerText = 'Questions are drawn randomly from the 200-question bank.';
  }
  render();
});

function shuffle(a){ return a.sort(function(){return Math.random()-0.5}); }

function render(){
  var qa = quizQuestions[current];
  var area = document.getElementById('question-area');
  area.innerHTML = '';
  if(!qa){ area.innerHTML = '<p>No questions</p>'; return; }
  var qdiv = document.createElement('div');
  qdiv.className='question';
  qdiv.innerHTML = '<h3>Q'+(current+1)+'. '+qa.question+'</h3>';
  area.appendChild(qdiv);
  if(qa.type==='mcq'){
    qa.choices.forEach(function(c,i){
      var btn = document.createElement('div');
      btn.className='choice';
      btn.innerText = c;
      btn.onclick = function(){ answers[qa.id]=c; highlightSelected(); };
      area.appendChild(btn);
    });
  } else if(qa.type==='tf'){
    ['True','False'].forEach(function(t){
      var btn = document.createElement('div');
      btn.className='choice';
      btn.innerText = t;
      btn.onclick = function(){ answers[qa.id]= (t==='True'); highlightSelected(); };
      area.appendChild(btn);
    });
  } else if(qa.type==='short'){
    var input = document.createElement('input');
    input.type='text'; input.style.width='100%'; input.placeholder='Type your answer here';
    input.value = answers[qa.id] || '';
    input.onchange = function(){ answers[qa.id]=input.value; };
    area.appendChild(input);
  }
  highlightSelected();
  document.getElementById('prevBtn').onclick = function(){ if(current>0){ current--; render(); } };
  document.getElementById('nextBtn').onclick = function(){ if(current<quizQuestions.length-1){ current++; render(); } };
  document.getElementById('finishBtn').onclick = finish;
}

function highlightSelected(){
  var qa = quizQuestions[current];
  var nodes = document.querySelectorAll('.choice');
  nodes.forEach(function(n){ n.style.background=''; });
  if(!qa) return;
  var sel = answers[qa.id];
  nodes.forEach(function(n){
    if(qa.type==='mcq' && n.innerText===sel) n.style.background='#e6f2ff';
    if(qa.type==='tf' && ((sel===true && n.innerText==='True') || (sel===false && n.innerText==='False'))) n.style.background='#e6f2ff';
  });
}

function finish(){
  var correct=0, total=quizQuestions.length;
  quizQuestions.forEach(function(q){
    var a = answers[q.id];
    if(q.type==='mcq' && a===q.answer) correct++;
    if(q.type==='tf' && ((a===true && q.answer===true) || (a===false && q.answer===false))) correct++;
    if(q.type==='short' && typeof a==='string' && a.trim().toLowerCase()===String(q.answer).trim().toLowerCase()) correct++;
  });
  var pct = Math.round((correct/total)*100);
  document.getElementById('results').innerHTML = '<p>Score: <strong>'+correct+'/'+total+'</strong> ('+pct+'%)</p>';
  document.getElementById('quiz-card').style.display='none';
  document.getElementById('results-card').style.display='block';
}

document.getElementById('retry').onclick = function(){ location.reload(); }
</script>
</body>
</html>
